\chapter{绪论}
\section{课题背景以及来源}
	嵌入式系统目前不断发展和壮大，使用嵌入式的场景越来越多，同时对嵌入式系统进行软件开发和移植工作也越来越多，由于每种嵌入式系统都有不同的软件接口和特性。所以在不同的嵌入式系统上进行软件开发和移植工作要根据其特性使用不同的方法，在我们所熟悉的通用操作系统(Linux、Windows、MacOS)下进行软件设计和开发时它们通常都会有现成的集成开发环境和调试工具。
	然而在嵌入式软件的开发和移植过程当中，由于嵌入式设备所独有的特点，对嵌入式系统上的软件的调试、分析一直是一个费时费力的工作。在整个的嵌入式的开发过程当中软件的调试占据了软件开发周期中的大部分时间。这是因为在设计软件时难免会出现各种各样的错误，这些错误可能需要进过反复的修改才能够达到设计的要求。因此一个好的调试、分析工具可以给嵌入式软件开发人员带来很大的帮助，使其达到事半功倍的效果，快速完成软件开发过程中的调试、分析，软件运行过程中调试信息的定位等工作。
	
	VxWorks因为其可靠性和实时性被广泛地应用对系统的实时性要求很高的领域当中，如：通信、航天、军事等\cite{刘小军2008基于}，在进行VxWorks应用程序的开发或者是将Linux下的应用程序移植到VxWorks中时都需要在程序中加入大量的调试信息，在程序的正常运行当中也需要输出一些日志信息，方便之后对程序运行过程中产生的问题进行具体的分析。目前VxWorks当中使用WorkBench集成开发平台来完成软件的开发、调试工作，这是一种典型的在线调试方式\cite{陈洋2007VxWorks}\cite{张鹏2007基于}，但是在中船重工的实际生产环境当中他们希望使用一种离线的调试日志的方式来进行程序的调试工作，它们希望在设备运行的大量应用程序当中加入调试信息，这些调试信息都能够自动的传输到普通的PC上，他们能够在之后查看其调试信息，对这些信息分析工作。并且通常对于宿主机和目标机之间的传输都是通过网口或者串口，然而目前的大多设备都已不再将RS-232的串口作为必须的标准接口，而是大量的使用USB接口，嵌入式设备上又大多没有配备网口的需求，因此在调试信息的传输过程中只能够使用USB接口。
	
	本次基于VxWorks的调试通道的设计来源于中船重工的实际需求，我们基于VxWorks开发出一个小巧易用的调试信息的传输通道，方便它们将应用程序的调试信息传输出来，以进行一个事后的分析工作，对于底层的信息传输我们使用USB转串口来实现，USB转串口的转换器使用CP2102模块来实现，并在此基础上设计了给应用层使用的调试接口。
	
			
\section{国内外概况}
	
	在嵌入式系统上由于其资源有限，所以在嵌入式系统上的调试必须采用交叉调试的方式。用户无法直接在嵌入式系统平台上调试被调试的程序，因此必须要借助于宿主机上丰富的调试资源通过一定的调试通道配合目标机共同完成对被调试程序执行状态的实时跟踪，从而快速有效地对程序错误进行定位，纠正错误，提高调试速率和软件质量。
	
	目前嵌入式系统上主要使用三类的调试技术进行调试。

	
	\textbf{1. 目标监控程序调试技术}
	
	目标监控程序调试技术是在目标机中植入一段特殊的代码即监控程序来实现对目标机的调试控制宿主机和目标机之间可以仅仅通过通过简单的通讯设备（如网口，串口等进行连接），不需要额外的硬件开销，同时在目标机上也不需要特殊的硬件支持。目标监控程序调试技术又可以根据监控程序的实现方式不同而分为两种：一种是作为一个独立的程序运行在目标机上，如GDBServer，ROM Monitor,这种方式下的监控程序主要是作为一个操作系统上的应用程序用于用户用户应用程序的调试。若要实现对操作系统进行调试，则需要同时具备完成简单的硬件初始化、下载以及调试被调试程序的功能；开发难度较大。另外一种是监控程序编译进操作系统镜像之后一起在目标机上运行，如GDB Stub、VxWorks的target agent、Windows CE的KITL调试技术等等，这种监控方式可以直接调用操作系统中的可用代码(如设备驱动)，减少代码的开发量，还可以方便的进行接口功能扩展，丰富调试通道，解决了接口资源受限目标机的调试问题，同时监控程序一般都可以同时用于操作系统以及用户应用程序的调试。
	
	\textbf{2. 片上调试技术}
	
	片上调试技术是随着芯片技术发展特别是处理器的封装越来越表贴化，加大了ICE的仿真探头开发难度的情况下发展起来的，是通过在目标机处理内部集成调试模块来接管被调试程序的运行控制完成调试操作的。
	片上调试技术使用两级模式：运行模式和调试模式，在调试模式下通过目标机上的提供的调试端口同宿主机交互信息完成调试功能。根据芯片调试接口支持不同，常用的片上调试技术包括:BDM调试技术。BDM也叫后天调试适配器。BDM调试是利用处理器内部提供的BDM，增加一个可以插入后台模式指令激活后台处理的串行口作为在线仿真接口，在定义的执行点上，由在线仿真器将后台调试指令覆盖在原代码上，控制目标处理器的运行和停止。
	
	
	\textbf{3. 利用打印信息进行调试}\\
	利用打印信息进行调试是最一般的调试技术，这种技术也称为监视，只需要应用程序内部适当的地方加上printf调用即可。这样就可以完成对应用程序中相关变量的监视工作，进而推断出错误所在。这种调试方式简单方便，不需要复杂的设置，但是缺点是获取到的信息有限且不能进行断点设置，单步执行等操作。
		
	
	
	在这些调试技术领域中，宿主机和目标机之间的通信方式主要有串口方式、以太网接口，大多数的远程调试中使用的是串口传输方式，但是串口通信存在着速度慢、通信距离受限等弊端，而以太网口的传输方式则可以克服串口方式的不足，不仅可以提供稳定可靠的数据传输，而且无论是传输速度还是传输距离都远远优于串口方式，是一种快速高效的通信方式，但是网络传输需要网络芯片的支持，而很多的嵌入式设备并没有这种需求，所以很所设备上无法实现网络传输的范式来进行调试，目前USB已经成为嵌入式平台的通用接口，使用USB做为传输方式已经广泛的应用在嵌入式系统的开发当中，逐渐替代了RS-232接口，USB不仅可以实现直接传输，还可以使用CDC协议虚拟成其他通信设备进行传输，USB在调试技术方面的使用也有相关的研究，如GDB中的USB Network调试的实现，但是USB应用在这方面的资料相对较少，因此对其进行研究与实现具有重要的意义。

	
	对于USB口转串口的转换器，国内外通常都会采用两种方案：一种是以CY7C68013芯片为代表,自己从底层的硬件和固件开始，进行彻底而全面的系统开发，这种方案的成本和开发难度都很大，通常都不会使用这种方案。另外一个方案是采用类似于CP2102等专用的双向USB口转串口芯片来进行设计，这种方案简单实用，只需要对芯片的功能进行了解和应用即可，无需深入开发\cite{Yao2009Design}\cite{Zhou2002The}。因此我们在此会选择CP2102芯片来进行调试通道的设计。	


	
	

\section{论文的主要工作和组织结构}	
	主要工作：在嵌入式实时操作系统VxWorks上实现一个能够满足程序的调试信息输出的通道，主要包括两个部分：一个将USB总线技术和RS-232接口相结合，设计出一个满足特定要求的、实用的USB转串口驱动程序;另一个是设计给应用层调用的日志传输接口封装程序和标准输出重定向接口封装程序。\\
 本文共分为六章来进行描述，对每一个章节我们做了如下的安排：
 
 第一章为绪论部分，主要描述了本次的课题的背景和来源、国内外的发展状况以及本文的结构安排。
 
 第二章介绍了首先介绍对于我们的调试通道的总体设计，然后介绍了调试通道的开发所需要了解的系统知识和关键技术，主要包括VxWorks系统及驱动开发的知识、USB技术相关知识。
 
 第三章介绍了USB口转串口驱动程序的设计和实现，包括驱动程序程序当中对于缓冲区和信号量的设计，我们使用CP2102模块开发和VxWorks下的USB开发的内容，然后给出了USB口转串口驱动的具体实现，包括特定需求下的单设备驱动和多设备支持的驱动
 
 第四章主要介绍了应用层的接口封装部分，主要包括Log接口的设计，标准输出重定向接口的设计，以及PC客户端的协议解析部分。
 
 第五章主要内容是系统的功能测试部分，我们进行了整体测试和各个部分的功能测试。
 
 最后在结束语部分对整个的工作进行了总结，指出了本次的工作的不足之处，并对下一步的工作进行了展望。 

